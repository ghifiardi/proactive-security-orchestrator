name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    name: Run Security Scanner
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # -----------------------------------------------------------
      # 1. CHECKOUT TARGET REPO
      # -----------------------------------------------------------
      - name: Checkout target repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2. SETUP PYTHON (CLEAN ENV)
      # -----------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------------------------------
      # 3. INSTALL SYSTEM DEPENDENCIES (SEMGREP + GITLEAKS)
      # -----------------------------------------------------------
      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep==1.43.1

      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64 \
            -o /usr/local/bin/gitleaks
          chmod +x /usr/local/bin/gitleaks

      # -----------------------------------------------------------
      # 4. INSTALL ORCHESTRATOR (LATEST COMMIT FROM MAIN)
      # -----------------------------------------------------------
      - name: Install Orchestrator CLI
        run: |
          pip install --upgrade pip wheel build
          pip install git+https://github.com/ghifiardi/proactive-security-orchestrator.git@main

      # -----------------------------------------------------------
      # 5. RUN ORCHESTRATOR SECURITY SCAN
      # -----------------------------------------------------------
      - name: Run security scan
        id: scan
        continue-on-error: true
        run: |
          echo "Running orchestrator security scan..."
          security-scan scan . \
            --format sarif \
            --output findings.sarif \
            --config "security-scan-config.yml" || true

          if [ ! -f findings.sarif ]; then
            echo "SARIF output missing, creating empty file to avoid CI failure"
            echo "{}" > findings.sarif
          fi

      # -----------------------------------------------------------
      # 6. UPLOAD SARIF TO GITHUB CODE SCANNING
      # -----------------------------------------------------------
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: findings.sarif

      # -----------------------------------------------------------
      # 7. UPLOAD FINDINGS AS ARTIFACT
      # -----------------------------------------------------------
      - name: Upload findings as artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: findings.sarif
          if-no-files-found: warn
